<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PreStaphy</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        .container {
            max-width: 100%; /* 改为最大宽度100%，不再限制为800px */
            width: 100%;
            padding: 0 20px;
            margin-top: 30px;
        }
        .content-wrapper {
            max-width: 1200px; /* 主内容区最大宽度 */
            margin: 0 auto;
        }
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        #results {
            margin-top: 20px;
            display: none;
            overflow-x: auto; /* 允许横向滚动 */
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #7066e0;
        }
        .upload-area.active {
            border-color: #7066e0;
            background-color: rgba(112, 102, 220, 0.1);
        }
        #fileInput {
            display: none;
        }
        .model-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
        /* 表格样式优化 */
        .table-responsive {
            min-width: 900px; /* 表格最小宽度，确保内容不拥挤 */
        }
        table th, table td {
            white-space: nowrap; /* 防止内容换行 */
            padding: 8px 12px;
            min-width: 120px; /* 单元格最小宽度 */
        }
        table th:first-child, table td:first-child {
            min-width: 200px; /* SMILES列更宽一些 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="content-wrapper">
            <h1 style="display: inline-block; margin-right: 15px;">PreStaphy</h1>
            <h4 style="display: inline-block; vertical-align: middle; color: #666;">(Predicting the inhibitory probability of compounds on <i>Staphylococcus aureus</i>)</h4>
    
            <!-- 模型选择 -->
            <div class="mb-3">
                <label for="modelSelect" class="form-label">选择模型</label>
                <select class="form-select" id="modelSelect">
                    <option value="Model all">Model all (综合所有模型结果)</option>
                    <!-- 模型选项将通过JS动态加载 -->
                </select>
                <div class="model-info" id="modelInfo">选择模型后显示默认阈值信息</div>
            </div>
            
            <!-- 阈值设置 -->
            <div class="mb-3">
                <label for="thresholdInput" class="form-label">预测阈值</label>
                <input type="number" class="form-control" id="thresholdInput" min="0.01" max="0.99" step="0.01" value="0.94">
            </div>
            
            <!-- 文件上传区域 -->
            <div class="upload-area" id="uploadArea">
                <p>点击或拖拽CSV文件到这里上传</p>
                <p class="text-muted">或</p>
                <button class="btn btn-primary" id="browseBtn">浏览文件</button>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            
            <!-- 文本输入区域 -->
            <div class="mb-3">
                <label for="smilesInput" class="form-label">或直接输入SMILES序列（每行一个）</label>
                <textarea class="form-control" id="smilesInput" rows="5" placeholder="例如:&#10;CCC(=O)O&#10;CCN(C)C(=O)C"></textarea>
            </div>
            
            <!-- 预测按钮 -->
            <button class="btn btn-success" id="predictBtn">开始预测</button>
            
            <!-- 进度显示 -->
            <div class="progress-container">
                <div class="progress">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div id="progressText" class="mt-2 text-center"></div>
            </div>
            
            <!-- 结果显示 -->
            <div id="results">
                <h3>Results</h3>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>SMILES</th>
                                <th>Pre_robability</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable">
                            <!-- 结果将通过JS动态填充 -->
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-primary" id="downloadBtn">下载结果</button>
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // 全局变量存储模型信息
        let modelData = {
            models: [],
            default_thresholds: {}
        };
        
        // 页面加载时获取模型列表
        $(document).ready(function() {
            // 加载模型列表
            $.get('/api/models')
                .done(function(data) {
                    // 保存模型数据
                    modelData = data;
                    
                    const modelSelect = $('#modelSelect');
                    // 清除现有选项（保留"Model all"）
                    modelSelect.find('option:not(:first)').remove();
                    
                    // 确保有模型可添加
                    if (data.models && data.models.length > 0) {
                        // 添加模型选项
                        data.models.forEach(model => {
                            const threshold = data.default_thresholds[model] || '未设置';
                            modelSelect.append(`<option value="${model}">${model} (默认阈值: ${threshold})</option>`);
                        });
                        $('#modelInfo').text(`共加载 ${data.models.length} 个模型`);
                    } else {
                        $('#modelInfo').text('未加载到任何模型，请检查后端服务');
                        $('#predictBtn').prop('disabled', true);
                    }
                    
                    // 设置阈值变更事件
                    modelSelect.change(function() {
                        updateThresholdAndInfo();
                    });
                    
                    // 初始更新一次
                    updateThresholdAndInfo();
                })
                .fail(function(xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: '模型加载失败',
                        text: `无法连接到后端服务: ${error}`,
                        confirmButtonText: '重试'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            location.reload();
                        }
                    });
                    $('#modelInfo').text('模型加载失败，请检查后端服务');
                    $('#predictBtn').prop('disabled', true);
                });
            
            // 文件上传区域事件
            const uploadArea = $('#uploadArea');
            const fileInput = $('#fileInput');
            const browseBtn = $('#browseBtn');
            
            browseBtn.click(function() {
                fileInput.click();
            });
            
            fileInput.change(function(e) {
                if (e.target.files.length > 0) {
                    uploadArea.addClass('active');
                    uploadArea.find('p:first').text(`已选择文件: ${e.target.files[0].name}`);
                }
            });
            
            // 拖拽事件
            uploadArea.on('dragover', function(e) {
                e.preventDefault();
                uploadArea.addClass('active');
            });
            
            uploadArea.on('dragleave', function() {
                uploadArea.removeClass('active');
            });
            
            uploadArea.on('drop', function(e) {
                e.preventDefault();
                uploadArea.removeClass('active');
                
                if (e.originalEvent.dataTransfer.files.length > 0) {
                    fileInput[0].files = e.originalEvent.dataTransfer.files;
                    uploadArea.find('p:first').text(`已选择文件: ${e.originalEvent.dataTransfer.files[0].name}`);
                }
            });
            
            // 预测按钮点击事件
            $('#predictBtn').click(function() {
                startPrediction();
            });
            
            // 下载按钮点击事件
            $('#downloadBtn').click(function() {
                downloadResults();
            });
        });
        
        // 更新阈值和模型信息
        function updateThresholdAndInfo() {
            const selectedModel = $('#modelSelect').val();
            if (selectedModel === "Model all") {
                $('#thresholdInput').val(0.94).prop('disabled', true);
                $('#modelInfo').text('综合所有模型结果，使用固定阈值 0.94');
            } else {
                const threshold = modelData.default_thresholds[selectedModel];
                if (threshold !== undefined) {
                    $('#thresholdInput').val(threshold).prop('disabled', false);
                    $('#modelInfo').text(`当前模型: ${selectedModel}，默认阈值: ${threshold}`);
                }
            }
        }
        
        // 开始预测
        function startPrediction() {
            const model = $('#modelSelect').val();
            const threshold = parseFloat($('#thresholdInput').val());
            const fileInput = $('#fileInput')[0];
            const smilesText = $('#smilesInput').val().trim();
            
            // 验证输入
            if (fileInput.files.length === 0 && !smilesText) {
                Swal.fire({
                    icon: 'warning',
                    title: '输入为空',
                    text: '请上传文件或输入SMILES序列'
                });
                return;
            }
            
            // 显示进度条
            $('.progress-container').show();
            updateProgress(0, '准备处理数据...');
            
            // 处理输入数据
            let smilesList = [];
            
            if (fileInput.files.length > 0) {
                // 处理上传的文件
                Papa.parse(fileInput.files[0], {
                    header: true,
                    complete: function(results) {
                        // 查找SMILES列
                        const columns = results.meta.fields;
                        let smilesColumn = null;
                        
                        columns.forEach(col => {
                            if (col.toLowerCase().includes('smile')) {
                                smilesColumn = col;
                            }
                        });
                        
                        if (!smilesColumn) {
                            Swal.fire({
                                icon: 'error',
                                title: '列未找到',
                                text: '未找到SMILES相关列，请确保列名包含"smile"'
                            });
                            $('.progress-container').hide();
                            return;
                        }
                        
                        // 提取SMILES
                        results.data.forEach(row => {
                            if (row[smilesColumn]) {
                                smilesList.push(row[smilesColumn].trim());
                            }
                        });
                        
                        if (smilesList.length === 0) {
                            Swal.fire({
                                icon: 'warning',
                                title: '无有效数据',
                                text: '未从文件中找到有效的SMILES序列'
                            });
                            $('.progress-container').hide();
                            return;
                        }
                        
                        sendPredictionRequest(model, threshold, smilesList);
                    },
                    error: function(error) {
                        Swal.fire({
                            icon: 'error',
                            title: '文件解析错误',
                            text: `解析文件时出错: ${error.message}`
                        });
                        $('.progress-container').hide();
                    }
                });
            } else {
                // 处理文本输入
                smilesList = smilesText.split('\n').filter(s => s.trim() !== '');
                if (smilesList.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: '无有效数据',
                        text: '请输入有效的SMILES序列'
                    });
                    $('.progress-container').hide();
                    return;
                }
                sendPredictionRequest(model, threshold, smilesList);
            }
        }
        
        // 发送预测请求
        function sendPredictionRequest(model, threshold, smilesList) {
            updateProgress(20, `正在准备预测 ${smilesList.length} 个分子...`);
            
            // 检查Web Worker支持
            if (typeof Worker !== 'undefined') {
                // 使用Web Worker处理预测，避免阻塞UI
                try {
                    const worker = new Worker('prediction_worker.js');
                    
                    worker.postMessage({
                        model: model,
                        threshold: threshold,
                        smilesList: smilesList
                    });
                    
                    worker.onmessage = function(e) {
                        if (e.data.type === 'progress') {
                            updateProgress(e.data.progress, e.data.message);
                        } else if (e.data.type === 'result') {
                            updateProgress(100, '预测完成');
                            displayResults(e.data.results);
                        } else if (e.data.type === 'error') {
                            Swal.fire({
                                icon: 'error',
                                title: '预测出错',
                                text: e.data.message
                            });
                            $('.progress-container').hide();
                        }
                        // 完成后终止worker
                        if (e.data.type === 'result' || e.data.type === 'error') {
                            worker.terminate();
                        }
                    };
                    
                    worker.onerror = function(error) {
                        console.error('Worker错误详情:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Worker错误',
                            text: `预测处理出错: ${error.message || '未知错误'}`
                        });
                        worker.terminate();
                        $('.progress-container').hide();
                    };
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: '初始化错误',
                        text: `无法初始化预测处理: ${error.message}`
                    });
                    $('.progress-container').hide();
                }
            } else {
                // 不支持Web Worker时的降级处理
                Swal.fire({
                    icon: 'info',
                    title: '浏览器不支持',
                    text: '您的浏览器不支持Web Worker，将使用普通方式处理'
                }).then(() => {
                    // 直接发送请求（可能会阻塞UI）
                    const url = model === "Model all" ? '/api/predict/all' : '/api/predict';
                    updateProgress(30, '正在发送预测请求...');
                    
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: model,
                            threshold: threshold,
                            smiles_list: smilesList
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.error || `服务器错误: ${response.status}`);
                            });
                        }
                        updateProgress(80, '正在处理结果...');
                        return response.json();
                    })
                    .then(data => {
                        updateProgress(100, '预测完成');
                        displayResults(data.results);
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: '预测出错',
                            text: error.message
                        });
                        $('.progress-container').hide();
                    });
                });
            }
        }
        
        // 更新进度
        function updateProgress(percent, message) {
            $('#progressBar').css('width', `${percent}%`).attr('aria-valuenow', percent);
            $('#progressText').text(message);
        }
        
// 显示结果
        function displayResults(results) {
            const tableBody = $('#resultsTable');
            tableBody.empty();
            
            // 获取所有模型名称和阈值（用于构建列名）
            const allModels = new Map(); // 使用Map保持顺序
            results.forEach(item => {
                if (item.models) {
                    Object.keys(item.models).forEach(model => {
                        if (!allModels.has(model)) {
                            // 存储模型名称和对应的阈值
                            allModels.set(model, item.models[model].threshold);
                        }
                    });
                }
            });
            // 转换为数组并排序
            const modelEntries = Array.from(allModels.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            
            // 构建表头
            const tableHead = $('#resultsTable').closest('table').find('thead tr');
            tableHead.empty();
            tableHead.append('<th>SMILES</th>');
            // 添加平均概率列（使用综合模型阈值）
            tableHead.append('<th>Model_all_0.94</th>');
            // 添加每个模型的列（列名格式：ModelX_阈值）
            modelEntries.forEach(([modelName, threshold]) => {
                tableHead.append(`<th>${modelName}_${threshold}</th>`);
            });
            tableHead.append('<th>Category</th>');
            
            results.forEach(item => {
                if (item.error) {
                    // 错误行（跨所有列）
                    const errorCols = 2 + modelEntries.length; // SMILES + 平均 + 每个模型1列 + 类别
                    tableBody.append(`
                        <tr class="table-danger">
                            <td colspan="${errorCols}">${item.smiles}: 错误: ${item.error}</td>
                        </tr>
                    `);
                } else if (item.combined) {  // 多模型结果
                    let rowHtml = `<tr><td>${item.smiles}</td>`;
                    // 平均概率（对应Model_all_0.94列）
                    rowHtml += `<td>${item.combined.average_probability.toFixed(4)}</td>`;
                    
                    // 为每个模型添加概率列
                    modelEntries.forEach(([modelName, _]) => {
                        const model = item.models[modelName] || {};
                        rowHtml += `<td>${model.probability ? model.probability.toFixed(4) : '-'}</td>`;
                    });
                    
                    rowHtml += `<td class="${item.combined.final_category === 'positive' ? 'text-success' : 'text-danger'}">
                        ${item.combined.final_category}
                    </td></tr>`;
                    tableBody.append(rowHtml);
                } else {  // 单模型结果
                    let rowHtml = `<tr><td>${item.smiles}</td>`;
                    rowHtml += `<td>${item.pre_probability.toFixed(4)}</td>`;
                    
                    // 填充其他模型列（单模型时为空）
                    modelEntries.forEach(() => {
                        rowHtml += `<td>-</td>`;
                    });
                    
                    rowHtml += `<td class="${item.pre_category === 'positive' ? 'text-success' : 'text-danger'}">
                        ${item.pre_category}
                    </td></tr>`;
                    tableBody.append(rowHtml);
                }
            });
            
            $('#results').show();
            // 保存结果以备下载
            window.predictionResults = {
                results: results,
                modelEntries: modelEntries // 保存模型列表和阈值用于下载
            };
        }

        // 下载结果
        function downloadResults() {
            if (!window.predictionResults || !window.predictionResults.results) return;
            
            const { results, modelEntries } = window.predictionResults;
            // 构建表头：SMILES + 平均概率列 + 各模型列 + 预测类别
            let headers = ['SMILES', 'Model_all_0.94'];
            modelEntries.forEach(([modelName, threshold]) => {
                headers.push(`${modelName}_${threshold}`);
            });
            headers.push('Category');
            
            let rows = [];
            
            // 处理结果行
            results.forEach(item => {
                if (item.error) {
                    // 错误行
                    const errorRow = new Array(headers.length).fill('');
                    errorRow[0] = item.smiles;
                    errorRow[headers.length - 1] = `错误: ${item.error}`;
                    rows.push(errorRow);
                } else if (item.combined) {
                    // 多模型结果行
                    let rowData = [
                        item.smiles,
                        item.combined.average_probability.toFixed(4)
                    ];
                    
                    // 添加每个模型的概率
                    modelEntries.forEach(([modelName, _]) => {
                        const model = item.models[modelName] || {};
                        rowData.push(model.probability ? model.probability.toFixed(4) : '');
                    });
                    
                    rowData.push(item.combined.final_category);
                    rows.push(rowData);
                } else {
                    // 单模型结果行
                    let rowData = [
                        item.smiles,
                        item.pre_probability.toFixed(4)
                    ];
                    
                    // 填充其他模型列（单模型时为空）
                    modelEntries.forEach(() => {
                        rowData.push('');
                    });
                    
                    rowData.push(item.pre_category);
                    rows.push(rowData);
                }
            });
            
            // 生成CSV内容
            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => {
                    if (cell.includes(',') || cell.includes('"')) {
                        return `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                }).join(',') + '\n';
            });
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `prediction_results_${new Date().getTime()}.csv`);
            document.body.appendChild(a);
            a.click();
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
    </script>
</body>
</html>
